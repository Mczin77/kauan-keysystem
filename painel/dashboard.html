<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Administrativo - Key System</title>

<style>
    /* SEGURAN√áA VISUAL: O corpo come√ßa invis√≠vel */
    body {
        display: none; /* Esconde tudo at√© verificar o login */
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #0f0f0f;
        color: #e0e0e0;
        height: 100vh;
        overflow: hidden;
        /* flex ser√° adicionado via JS se o login for ok */
    }

    /* LAYOUT PRINCIPAL */
    body.logged-in {
        display: flex;
    }

    /* MENU LATERAL */
    .sidebar {
        width: 250px;
        background: #141414;
        padding: 20px;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .sidebar h2 {
        text-align: center;
        color: #00aaff;
        margin-bottom: 30px;
        font-size: 22px;
    }

    .sidebar button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background: transparent;
        border: 1px solid #333;
        border-radius: 6px;
        color: #e0e0e0;
        cursor: pointer;
        transition: background 0.2s, border-color 0.2s;
    }

    .sidebar button:hover:not(.active) {
        background: #1a1a1a;
        border-color: #00aaff;
    }

    .sidebar button.active {
        background: #00aaff;
        border-color: #00aaff;
        color: #fff;
        font-weight: bold;
    }

    /* CONTE√öDO PRINCIPAL */
    .main-content {
        flex-grow: 1;
        padding: 30px;
        overflow-y: auto;
    }

    .main-content h1 {
        color: #00aaff;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
    }

    /* ESTILOS DE TABELA */
    .key-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px; /* Espa√ßo entre as linhas */
    }

    .key-table th, .key-table td {
        padding: 12px 15px;
        text-align: left;
    }

    .key-table th {
        background: #1a1a1a;
        color: #00aaff;
        font-size: 14px;
        text-transform: uppercase;
    }

    .key-table tbody tr {
        background: #1e1e1e;
        transition: background 0.2s;
        border-radius: 6px;
    }
    
    .key-table tbody tr:hover {
        background: #282828;
    }

    .key-table tbody tr td:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
    .key-table tbody tr td:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }

    .btn-action {
        background: #ff4444;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        margin-left: 5px;
        white-space: nowrap;
    }
    .btn-action.delete { background: #ff4444; }
    .btn-action.delete:hover { background: #cc0000; }
    .btn-action.assign { background: #00aaff; }
    .btn-action.assign:hover { background: #0088cc; }
    .btn-action.notify { background: #ffaa00; }
    .btn-action.notify:hover { background: #cc8800; }

    /* FORMUL√ÅRIO DE GERA√á√ÉO */
    .creation-form {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .input-group {
        display: flex;
        flex-direction: column;
    }

    .input-group label {
        margin-bottom: 5px;
        color: #aaa;
        font-size: 14px;
    }

    .creation-form input[type="number"], .creation-form input[type="text"], .creation-form select {
        padding: 8px;
        border: 1px solid #333;
        background: #282828;
        color: #e0e0e0;
        border-radius: 4px;
        width: 80px; /* Largura ajustada para caber todos */
    }
    
    .creation-form select {
        width: 120px;
    }
    
    .creation-form button {
        padding: 10px 20px;
        background: #00aaff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .creation-form button:hover {
        background: #0088cc;
    }
    
    /* MODAIS GERAIS (Login, Atribui√ß√£o) */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .modal-backdrop.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        background: #1a1a1a;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 350px;
        transform: translateY(-50px);
        transition: transform 0.3s ease;
    }
    .modal-backdrop.active .modal-content {
        transform: translateY(0);
    }
    
    .modal-content input, .modal-content select, .modal-content textarea {
        padding: 10px;
        border: 1px solid #333;
        background: #282828;
        color: #e0e0e0;
        border-radius: 5px;
        font-size: 16px;
        resize: vertical;
    }
    
    .modal-content button {
        padding: 10px;
        background: #00aaff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .modal-content button:hover {
        background: #0088cc;
    }
    
    .modal-close {
        background: none;
        color: #aaa;
        border: none;
        align-self: flex-end;
        cursor: pointer;
        font-size: 18px;
    }

    /* ESTILO DE USU√ÅRIO VINCULADO NO MODAL */
    .discord-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        background: #282828;
        border-radius: 6px;
        margin-top: 10px;
        border: 1px solid #00aaff;
    }
    .discord-user-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    .discord-user-info div {
        display: flex;
        flex-direction: column;
    }
    .discord-user-info strong {
        color: #fff;
    }
    .discord-user-info span {
        font-size: 12px;
        color: #aaa;
    }

    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid #333;
            flex-direction: row;
            flex-wrap: wrap;
            padding: 10px;
        }
        .sidebar h2 { display: none; }
        .sidebar button { flex-grow: 1; margin: 5px; padding: 8px; }
        .menu-bottom { display: none; } /* Oculta status e sair no mobile */
        
        body.logged-in {
            flex-direction: column;
        }
        
        .creation-form {
            flex-direction: column;
            align-items: stretch;
        }
        
        .creation-form input[type="number"], .creation-form select {
            width: 100%; /* Largura total em mobile */
        }
        
        .creation-form button {
            margin-top: 10px;
        }
    }
</style>
</head>
<body>

<!-- 1. MODAL DE LOGIN -->
<div class="modal-backdrop active" id="loginModal">
    <div class="modal-content">
        <h2>Painel Login</h2>
        <input type="password" id="passwordInput" placeholder="Senha do Painel">
        <button onclick="login()">Entrar</button>
        <p id="loginMessage" style="color: #ff4444; display: none; margin-top: 5px; text-align: center;">Senha Incorreta</p>
    </div>
</div>

<!-- 2. MODAL DE VINCULA√á√ÉO DE DISCORD -->
<div class="modal-backdrop" id="assignModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAssignModal()">√ó</button>
        <h2>Vincular Key (<span id="assignKeyDisplay"></span>)</h2>
        
        <label for="discordIdInput">ID do Usu√°rio Discord:</label>
        <input type="text" id="discordIdInput" placeholder="Ex: 123456789012345678">
        
        <button onclick="fetchDiscordUser()">Buscar Usu√°rio</button>
        
        <div id="userInfoContainer" style="display: none;">
            <div class="discord-user-info">
                <img id="userAvatar" src="" alt="Avatar">
                <div>
                    <strong id="userNameDisplay"></strong>
                    <span id="userIdDisplay"></span>
                </div>
            </div>
        </div>

        <button id="assignButton" onclick="assignKey()" disabled>Vincular Key</button>
        <p id="assignMessage" style="color: #ffaa00; text-align: center; font-size: 14px;"></p>
    </div>
</div>

<!-- 3. MODAL DE NOTIFICA√á√ÉO -->
<div class="modal-backdrop" id="notifyModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeNotifyModal()">√ó</button>
        <h2>Notificar Key (<span id="notifyKeyDisplay"></span>)</h2>
        
        <label for="messageTypeSelect">Tipo de Mensagem:</label>
        <select id="messageTypeSelect" onchange="toggleCustomMessage()">
            <option value="time">Key Quase Expirando</option>
            <option value="revoke">Key Revogada</option>
            <option value="custom">Mensagem Personalizada</option>
        </select>
        
        <div id="customMessageContainer" style="display: none;">
            <label for="customMessageInput">Mensagem Personalizada:</label>
            <textarea id="customMessageInput" rows="4" placeholder="Digite a mensagem para o usu√°rio..."></textarea>
        </div>

        <button onclick="sendNotification()">Enviar Notifica√ß√£o</button>
        <p id="notifyMessage" style="color: #ffaa00; text-align: center; font-size: 14px;"></p>
    </div>
</div>


<!-- CONTE√öDO PRINCIPAL DO PAINEL -->
<div class="sidebar">
    <div class="menu-top">
        <h2>üîë Key System</h2>
        <button class="active" onclick="showSection('keys', this)">Gerenciar Keys</button>
        <button onclick="showSection('settings', this)">Configura√ß√µes</button>
    </div>
    <div class="menu-bottom">
        <p style="font-size: 12px; color: #555;">Status: <span id="connectionStatus" style="color: yellow;">Conectando...</span></p>
        <button onclick="logout()">Sair</button>
    </div>
</div>

<div class="main-content">
    
    <!-- 1. SE√á√ÉO DE GERENCIAMENTO DE KEYS -->
    <div id="keysSection" class="section">
        <h1>Gerenciar Keys</h1>
        
        <!-- FORMUL√ÅRIO DE CRIA√á√ÉO -->
        <div class="creation-form">
            <div class="input-group">
                <label for="typeInput">Tipo:</label>
                <select id="typeInput">
                    <option value="Standard">Standard</option>
                    <option value="VIP">VIP</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="daysInput">Dias:</label>
                <input type="number" id="daysInput" value="0" min="0">
            </div>
            
            <div class="input-group">
                <label for="hoursInput">Horas:</label>
                <input type="number" id="hoursInput" value="0" min="0" max="23">
            </div>
            
            <div class="input-group">
                <label for="minutesInput">Minutos:</label>
                <input type="number" id="minutesInput" value="0" min="0" max="59">
            </div>
            
            <button onclick="createKey()">Gerar Key</button>
        </div>
        
        <!-- TABELA DE KEYS -->
        <table class="key-table">
            <thead>
                <tr>
                    <th>Dono (Discord)</th>
                    <th>Key</th>
                    <th>Tipo</th>
                    <th>Dura√ß√£o</th>
                    <th>Status</th>
                    <th>Usos</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="keysTableBody">
                <!-- Conte√∫do gerado via JS -->
            </tbody>
        </table>
    </div>
    
    <!-- 2. SE√á√ÉO DE CONFIGURA√á√ïES -->
    <div id="settingsSection" class="section" style="display: none;">
        <h1>Configura√ß√µes Globais</h1>
        <p>Em desenvolvimento...</p>
    </div>

</div>

<script>
const API_BASE = window.location.origin;
// A URL de a√ß√µes do Discord agora aponta para o arquivo unificado
const DISCORD_ACTIONS_URL = `${API_BASE}/api/discord_actions`;

let token = localStorage.getItem('panelToken');
let activeSection = 'keys';
let currentKeyToAssign = null; // Armazena a key que est√° sendo manipulada

// --- CONTROLE DE UI ---

function showSection(sectionId, buttonElement) {
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(sectionId + 'Section').style.display = 'block';
    
    document.querySelectorAll('.sidebar button').forEach(btn => {
        btn.classList.remove('active');
    });
    if (buttonElement) {
        buttonElement.classList.add('active');
    }
    
    activeSection = sectionId;
    if (sectionId === 'keys') {
        loadKeys();
    }
}

// --- UTILIDADES ---

function formatDuration(expiresAt) {
    // Se expiresAt for '0' (string de Firestore/Redis), retorna permanente
    if (String(expiresAt) === '0' || Number(expiresAt) === 0) return '<span style="color: #ffcc00; font-weight: bold;">PERMANENTE</span>';
    
    const now = Date.now();
    const expiry = new Date(Number(expiresAt)); // Converte para n√∫mero
    const diff = expiry - now;
    
    if (diff <= 0) return '<span style="color: #ff4444;">EXPIRADA</span>';
    
    const seconds = Math.floor(diff / 1000);
    const days = Math.floor(seconds / (3600 * 24));
    const hours = Math.floor((seconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    let durationStr = '';
    if (days > 0) durationStr += `${days}d `;
    if (hours > 0) durationStr += `${hours}h `;
    if (minutes > 0) durationStr += `${minutes}m`;
    
    return `<span style="color: #88ff88;">${durationStr.trim()}</span>`;
}


// --- AUTENTICA√á√ÉO ---

async function login() {
    const password = document.getElementById('passwordInput').value;
    const loginMessage = document.getElementById('loginMessage');
    
    try {
        const res = await fetch(`${API_BASE}/api/admin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        const data = await res.json();
        
        if (data.ok && data.token) {
            token = data.token;
            localStorage.setItem('panelToken', token);
            document.getElementById('loginModal').classList.remove('active');
            document.body.classList.add('logged-in'); // Exibe o corpo
            document.getElementById('connectionStatus').textContent = 'Online';
            document.getElementById('connectionStatus').style.color = '#50ff50'; // Verde
            // Ativa o primeiro bot√£o da sidebar (Gerenciar Keys)
            const firstButton = document.querySelector('.sidebar .menu-top button');
            if (firstButton) {
                showSection('keys', firstButton); 
            } else {
                 showSection('keys', null); // Garante que a se√ß√£o keys √© exibida
            }
        } else {
            loginMessage.textContent = data.message || 'Senha Incorreta';
            loginMessage.style.display = 'block';
        }
    } catch (e) {
        loginMessage.textContent = 'Erro de Conex√£o com a API.';
        loginMessage.style.display = 'block';
        document.getElementById('connectionStatus').textContent = 'Erro de API';
        document.getElementById('connectionStatus').style.color = '#ff4444'; // Vermelho
        console.error("Login Error:", e);
    }
}

function logout() {
    localStorage.removeItem('panelToken');
    window.location.reload();
}

// --- OPERA√á√ïES DE KEY (CRUD B√ÅSICO) ---

async function loadKeys() {
    if (!token) return; 
    
    const tbody = document.getElementById('keysTableBody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #aaa;">Carregando Keys...</td></tr>';

    try {
        const res = await fetch(`${API_BASE}/api/list`, {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'x-panel-token': token },
            body: JSON.stringify({})
        });

        const data = await res.json();
        
        if (!data.ok) {
             tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #ff4444;">ERRO: ${data.message || 'Falha ao carregar keys.'}</td></tr>`;
             return;
        }

        renderKeys(data.keys);

    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ff4444;">Erro de Conex√£o com o Servidor API.</td></tr>';
        console.error("Load Keys Error:", e);
    }
}

function renderKeys(keys) {
    const tbody = document.getElementById('keysTableBody');
    if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #aaa;">Nenhuma key cadastrada.</td></tr>';
        return;
    }
    
    let html = '';
    keys.forEach(k => {
        const expiresAtNumber = Number(k.expiresAt);
        const isRevoked = k.revoked === 'true';
        const isActive = !isRevoked && (expiresAtNumber === 0 || expiresAtNumber > Date.now());

        const statusColor = isRevoked ? '#ff4444' : (isActive ? '#50ff50' : '#ffcc00');
        const statusText = isRevoked ? 'REVOGADA' : (isActive ? 'ATIVA' : 'EXPIRADA');
        
        const ownerInfo = k.ownerId 
            ? `<div style="display:flex;align-items:center;gap:10px;"><img src="${k.ownerAvatar || 'https://placehold.co/30x30/333/fff?text=U'}" onerror="this.onerror=null;this.src='https://placehold.co/30x30/333/fff?text=U';" style="width:30px;height:30px;border-radius:50%;"><span>${k.ownerName || 'N/A'}</span></div>`
            : '<span style="color: #ff4444;">N√ÉO VINCULADA</span>';

        // Bot√£o de notifica√ß√£o s√≥ aparece se houver dono
        const notifyButton = k.ownerId 
            ? `<button class="btn-action notify" onclick="openNotifyModal('${k.key}')">Notificar</button>` 
            : '';
            
        // Bot√£o de vincular/desvincular
        const assignButton = k.ownerId 
            ? `<button class="btn-action assign" onclick="deleteKey('${k.key}')" title="Apagar Key desvincula o ID.">Desvincular</button>` // Apagar Key remove a vincula√ß√£o
            : `<button class="btn-action assign" onclick="openAssignModal('${k.key}')">Vincular</button>`;
        
        html += `
            <tr style="${isRevoked ? 'opacity: 0.5;' : ''}">
                <td>${ownerInfo}</td>
                <td style="font-family:monospace;color:#00aaff;">${k.key}</td>
                <td>${k.type}</td>
                <td>${formatDuration(k.expiresAt)}</td>
                <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                <td>${k.uses || 0}</td>
                <td>
                    ${assignButton}
                    ${notifyButton}
                    <button class="btn-action delete" onclick="deleteKey('${k.key}')">Apagar</button>
                </td>
            </tr>`;
    });
    tbody.innerHTML = html;
}

async function createKey() {
    const type = document.getElementById("typeInput").value;
    const days = parseInt(document.getElementById("daysInput").value) || 0;
    const hours = parseInt(document.getElementById("hoursInput").value) || 0; // Campo Hours restaurado
    const minutes = parseInt(document.getElementById("minutesInput").value) || 0;
    
    try {
        const res = await fetch(`${API_BASE}/api/generate`, {
            method: "POST", 
            headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ type, days, hours, minutes })
        });
        const data = await res.json();
        
        if (data.ok) {
            console.log(`Key Criada: ${data.key}`);
            alert(`Key Criada: ${data.key}`); 
            loadKeys();
        } else {
            alert(`Erro ao criar key: ${data.message || 'Erro desconhecido'}`);
        }
    } catch (e) { 
        alert("Erro de conex√£o com a API de gera√ß√£o."); 
        console.error("Create Key Error:", e);
    }
}

async function deleteKey(key) {
    if (!confirm(`Apagar key ${key}? Isso remover√° a Key permanentemente e desvincular√° qualquer ID Discord associado.`)) return;
    try {
        const res = await fetch(`${API_BASE}/api/delete`, {
            method: "POST", 
            headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ key })
        });
        const data = await res.json();
        
        if (data.ok) {
            loadKeys();
        } else {
            alert(`Erro ao apagar key: ${data.message || 'Erro desconhecido'}`);
        }
    } catch (e) { 
        alert("Erro de conex√£o com a API de dele√ß√£o.");
        console.error("Delete Key Error:", e);
    }
}

// --- MODAL VINCULAR DISCORD ---

function openAssignModal(key) {
    currentKeyToAssign = key;
    document.getElementById('assignKeyDisplay').textContent = key;
    document.getElementById('discordIdInput').value = '';
    document.getElementById('userInfoContainer').style.display = 'none';
    document.getElementById('assignButton').disabled = true;
    document.getElementById('assignMessage').textContent = '';
    document.getElementById('assignModal').classList.add('active');
}

function closeAssignModal() {
    currentKeyToAssign = null;
    document.getElementById('assignModal').classList.remove('active');
}

let fetchedUser = null; // Guarda os dados do usu√°rio buscado

// Usa o novo endpoint unificado /api/discord_actions com a action: "fetch_user"
async function fetchDiscordUser() {
    const discordId = document.getElementById('discordIdInput').value.trim();
    const messageDisplay = document.getElementById('assignMessage');
    
    messageDisplay.textContent = 'Buscando...';
    
    if (!discordId) {
        messageDisplay.textContent = 'Por favor, insira um ID.';
        return;
    }

    try {
        const res = await fetch(DISCORD_ACTIONS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ action: "fetch_user", id: discordId })
        });
        
        const data = await res.json();
        
        if (data.ok) {
            fetchedUser = data;
            
            // Atualiza a UI com as informa√ß√µes do usu√°rio
            document.getElementById('userNameDisplay').textContent = data.username || data.global_name || 'Usu√°rio Sem Nome';
            document.getElementById('userIdDisplay').textContent = `ID: ${data.id}`;
            document.getElementById('userAvatar').src = data.avatar;
            document.getElementById('userInfoContainer').style.display = 'flex';
            document.getElementById('assignButton').disabled = false;
            messageDisplay.textContent = `Usu√°rio '${data.username || data.global_name}' encontrado.`;
        } else {
            fetchedUser = null;
            document.getElementById('userInfoContainer').style.display = 'none';
            document.getElementById('assignButton').disabled = true;
            messageDisplay.textContent = data.message || 'Usu√°rio Discord n√£o encontrado. Verifique o ID.';
        }
    } catch (e) {
        messageDisplay.textContent = 'Erro de conex√£o com a API Discord.';
        console.error("Fetch Discord Error:", e);
    }
}

// Usa o novo endpoint unificado /api/discord_actions com a action: "assign"
async function assignKey() {
    if (!currentKeyToAssign || !fetchedUser) {
        alert('Erro: Key ou Usu√°rio n√£o selecionado.');
        return;
    }
    
    const messageDisplay = document.getElementById('assignMessage');
    messageDisplay.textContent = 'Vinculando...';
    document.getElementById('assignButton').disabled = true;

    try {
        const res = await fetch(DISCORD_ACTIONS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ 
                action: "assign", // A√ß√£o de vincula√ß√£o
                key: currentKeyToAssign,
                discordId: fetchedUser.id,
                discordName: fetchedUser.username || fetchedUser.global_name,
                discordAvatar: fetchedUser.avatar
            })
        });
        
        const data = await res.json();
        
        if (data.ok) {
            messageDisplay.textContent = `Sucesso! Key ${currentKeyToAssign} vinculada a ${fetchedUser.username || fetchedUser.global_name}.`;
            loadKeys();
            setTimeout(closeAssignModal, 2000); 
        } else {
            messageDisplay.textContent = data.message || 'Falha ao vincular Key.';
            document.getElementById('assignButton').disabled = false;
        }
    } catch (e) {
        messageDisplay.textContent = 'Erro de conex√£o ao vincular Key.';
        document.getElementById('assignButton').disabled = false;
        console.error("Assign Key Error:", e);
    }
}


// --- MODAL NOTIFICA√á√ÉO ---

function openNotifyModal(key) {
    currentKeyToAssign = key;
    document.getElementById('notifyKeyDisplay').textContent = key;
    document.getElementById('messageTypeSelect').value = 'time';
    document.getElementById('customMessageContainer').style.display = 'none';
    document.getElementById('customMessageInput').value = '';
    document.getElementById('notifyMessage').textContent = '';
    document.getElementById('notifyModal').classList.add('active');
}

function closeNotifyModal() {
    currentKeyToAssign = null;
    document.getElementById('notifyModal').classList.remove('active');
}

function toggleCustomMessage() {
    const type = document.getElementById('messageTypeSelect').value;
    document.getElementById('customMessageContainer').style.display = type === 'custom' ? 'block' : 'none';
}

// Usa o novo endpoint unificado /api/discord_actions com a action: "notify"
async function sendNotification() {
    if (!currentKeyToAssign) {
        alert('Erro: Key n√£o selecionada.');
        return;
    }

    const type = document.getElementById('messageTypeSelect').value;
    const customMessage = document.getElementById('customMessageInput').value.trim();
    const messageDisplay = document.getElementById('notifyMessage');

    if (type === 'custom' && !customMessage) {
        messageDisplay.textContent = 'A mensagem personalizada n√£o pode ser vazia.';
        return;
    }

    messageDisplay.textContent = 'Enviando notifica√ß√£o...';

    try {
        const res = await fetch(DISCORD_ACTIONS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ 
                action: "notify", // A√ß√£o de notifica√ß√£o
                key: currentKeyToAssign,
                messageType: type,
                customMessage: customMessage
            })
        });
        
        const data = await res.json();
        
        if (data.ok) {
            messageDisplay.textContent = `Sucesso! ${data.message}`;
            setTimeout(closeNotifyModal, 2000);
        } else {
            messageDisplay.textContent = data.message || 'Falha ao enviar notifica√ß√£o.';
        }
    } catch (e) {
        messageDisplay.textContent = 'Erro de conex√£o com a API de notifica√ß√£o.';
        console.error("Notify Error:", e);
    }
}


// --- INICIALIZA√á√ÉO ---

// Verifica se h√° token e tenta autenticar (para manter o login)
if (token) {
    login(); // Chama login para validar o token no backend
} else {
    // Se n√£o houver token, mostra o modal de login
    document.getElementById('loginModal').classList.add('active');
}

// Garante que a se√ß√£o de keys seja a primeira a carregar
document.addEventListener('DOMContentLoaded', () => {
    // Este bloco s√≥ √© realmente √∫til se o login n√£o estiver ativo, mas garante a consist√™ncia
    const firstButton = document.querySelector('.sidebar .menu-top button');
    if (!document.body.classList.contains('logged-in') && firstButton) {
        firstButton.classList.add('active');
    }
});

</script>
</body>
</html>
