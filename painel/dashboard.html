<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Administrativo - Mczin</title>

<style>
    /* SEGURAN√áA VISUAL: O corpo come√ßa invis√≠vel */
    body {
        display: none; /* Esconde tudo at√© verificar o login */
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #0f0f0f;
        color: #e0e0e0;
        height: 100vh;
    }

    /* MENU LATERAL */
    .sidebar {
        width: 250px;
        background: #141414;
        padding: 20px;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .sidebar h2 {
        text-align: center;
        color: #00aaff;
        margin-bottom: 30px;
        font-size: 22px;
    }

    .sidebar button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background: transparent;
        border: 1px solid #333;
        border-radius: 6px;
        color: #ccc;
        cursor: pointer;
        transition: 0.2s;
        font-size: 15px;
        text-align: left;
        padding-left: 20px;
    }

    .sidebar button:hover {
        background: #1f1f1f;
        border-color: #00aaff;
        color: #00aaff;
    }

    /* √ÅREA PRINCIPAL */
    .main {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
    }

    .card {
        background: #1a1a1a;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        margin-bottom: 20px;
    }

    .card h3 {
        margin-top: 0;
        color: #00aaff;
        border-bottom: 1px solid #333;
        padding-bottom: 15px;
    }

    /* FORMUL√ÅRIOS */
    .form-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
    .input-group { display: flex; flex-direction: column; flex: 1; }
    .input-group label { font-size: 12px; margin-bottom: 5px; color: #888; }
    input, select { background: #252525; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; outline: none; width: 100%; box-sizing: border-box; }
    input:focus, select:focus { border-color: #00aaff; }
    
    .btn-primary { background: #00aaff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; white-space: nowrap; }
    .btn-primary:hover { background: #0088cc; }

    /* TABELAS */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th { text-align: left; padding: 12px; background: #252525; color: #aaa; font-weight: normal; }
    td { padding: 12px; border-bottom: 1px solid #2a2a2a; vertical-align: middle; }
    tr:hover td { background: #202020; }
    
    /* TAGS E STATUS */
    .tag-vip { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-time { background: #00aaff; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .tag-revoked { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-active { background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-session { background: #2ecc71; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;  animation: pulse 2s infinite;}

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    /* BOT√ïES DE A√á√ÉO */
    .btn-delete { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-delete:hover { background: #cc0000; }
    
    .btn-revoke { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
    .btn-revoke:hover { background: #c0392b; }
    
    .btn-unrevoke { background: #2ecc71; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
    .btn-unrevoke:hover { background: #27ae60; }

    .discord-box { display: flex; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-top: 20px; }

</style>
</head>
<body>

<script>
(async function protectRoute() {
    // Tenta pegar do localStorage ou define o fixo aqui se preferir
    const token = localStorage.getItem("panel_token");
    
    if (!token) {
        window.location.href = "/";
        return;
    }

    try {
        const res = await fetch("/api/check", {
            headers: { "x-panel-token": token }
        });
        const data = await res.json();

        if (data.ok) {
            document.body.style.display = "flex";
            loadKeys(); 
        } else {
            localStorage.removeItem("panel_token");
            window.location.href = "/";
        }
    } catch (e) {
        window.location.href = "/";
    }
})();
</script>

<div class="sidebar">
    <div>
        <h2>‚ö° Mczin Painel</h2>
        <button onclick="loadHome()">üè† In√≠cio</button>
        <button onclick="loadKeys()">üîë Gerenciar Keys</button>
        <button onclick="loadUsers()">üë§ Usu√°rios & Discord</button>
    </div>

    <button onclick="logout()" style="border-color:#ff4d4d; color:#ff4d4d;">üö™ Sair</button>
</div>

<div class="main" id="content">
    </div>

<script>
// --- CONFIGURA√á√ÉO ---
const token = localStorage.getItem("panel_token"); 

function logout() {
    localStorage.removeItem("panel_token");
    window.location.href = "/";
}

let foundUser = null;

// --- FORMATA√á√ÉO ---
function formatTime(timestamp) {
    if (timestamp === 0 || timestamp === "0") return '‚àû Permanente';
    if (timestamp < Date.now()) return `<span style="color:#ff4d4d; font-weight:bold;">EXPIRADA</span>`;
    const date = new Date(Number(timestamp));
    return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

function formatLastUsed(timestamp) {
    if (timestamp === 0 || timestamp === "0") return 'Nunca';
    const date = new Date(Number(timestamp));
    return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

// --- NAVEGA√á√ÉO ---
function loadHome() {
    document.getElementById("content").innerHTML = `
        <div class="card">
            <h3>Bem-vindo ao painel üéâ</h3>
            <p>Selecione uma op√ß√£o no menu lateral para come√ßar.</p>
        </div>
    `;
}

// --- A√á√ïES DE KEY ---

async function revokeKey(key, state) {
    const action = state ? 'BLOQUEAR' : 'DESBLOQUEAR';
    if (!confirm(`Tem certeza que deseja ${action} a key ${key}?`)) {
        return;
    }

    try {
        const response = await fetch("/api/revoke", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-panel-token': token
            },
            body: JSON.stringify({ key, state })
        });
        const data = await response.json();

        if (data.ok) {
            loadKeys(); // Recarrega a tabela automaticamente
        } else {
            alert(`Erro: ${data.error || 'Falha na comunica√ß√£o.'}`);
        }
    } catch (error) {
        console.error(error);
        alert('Erro de rede.');
    }
}

async function deleteKey(key) {
    if (!confirm(`Apagar key ${key} permanentemente?`)) return;
    try {
        const res = await fetch("/api/delete", {
            method: "POST", headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ key })
        });
        if ((await res.json()).ok) loadKeys(); else alert("Erro ao deletar");
    } catch (e) { alert("Erro conex√£o"); }
}

async function createKey() {
    const type = document.getElementById("typeInput").value;
    const days = parseInt(document.getElementById("daysInput").value) || 0;
    const hours = parseInt(document.getElementById("hoursInput").value) || 0;
    const resultElement = document.getElementById("generateResult");

    resultElement.innerHTML = "Gerando...";
    
    try {
        const res = await fetch("/api/generate", {
            method: "POST", headers: { "Content-Type": "application/json", "x-panel-token": token },
            body: JSON.stringify({ type, days, hours, minutes: 0 }) 
        });
        const data = await res.json();
        if (data.ok) {
            resultElement.innerHTML = `‚úÖ Key Gerada: <strong style="color:#2ecc71;">${data.data.key}</strong>`;
            loadKeys(); 
        } else { 
            resultElement.innerHTML = `‚ùå Erro: <span style="color:#e74c3c;">${data.error || 'Erro desconhecido'}</span>`;
        }
    } catch (e) { 
        resultElement.innerHTML = `‚ùå Erro de conex√£o.`;
    }
}

// --- LISTAGEM DE KEYS ---

async function loadKeys() {
    const contentDiv = document.getElementById("content");
    // Mant√©m o formul√°rio se j√° existir, sen√£o cria o layout base
    if (!document.getElementById("keysTable")) {
        contentDiv.innerHTML = `
        <div class="card">
            <h3>Gerar Nova Key ‚ö°</h3>
            <div class="form-row">
                <div class="input-group" style="flex:none; width: 150px;">
                    <label>Tipo</label>
                    <select id="typeInput">
                        <option value="temp">Tempor√°rio</option>
                        <option value="vip">VIP (Permanente)</option>
                    </select>
                </div>
                <div class="input-group" style="flex:none; width: 80px;">
                    <label>Dias</label>
                    <input type="number" id="daysInput" value="1" min="0">
                </div>
                <div class="input-group" style="flex:none; width: 80px;">
                    <label>Horas</label>
                    <input type="number" id="hoursInput" value="0" min="0">
                </div>
                <div class="input-group" style="flex:none;">
                    <label>&nbsp;</label>
                    <button class="btn-primary" onclick="createKey()">+ Gerar Key</button>
                </div>
            </div>
            <p id="generateResult" style="margin-top:10px; font-size:14px;"></p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:15px;">
                <h3 style="border:none; margin:0;">Lista de Keys</h3>
                <button class="btn-primary" onclick="loadKeys()" style="padding: 8px 15px; font-size:13px;">üîÑ Atualizar</button>
            </div>
            <table id="keysTable">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Tipo</th>
                        <th>Validade</th>
                        <th>Usos</th> 
                        <th>HWID Vinculado</th>
                        <th>√öltimo Uso</th>
                        <th>Sess√£o</th>
                        <th>Revogado</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="keysTableBody">
                    <tr><td colspan="9" style="text-align:center">Carregando...</td></tr>
                </tbody>
            </table>
        </div>`;
    }

    const tableBody = document.getElementById("keysTableBody");

    try {
        const response = await fetch("/api/list", {
            method: "GET", headers: { "x-panel-token": token }
        });
        const data = await response.json();

        if (!data.ok) throw new Error("Erro ao buscar keys");

        // Ordena: Mais recentes (lastUsedAt) primeiro
        data.keys.sort((a, b) => (Number(b.lastUsedAt || 0) - Number(a.lastUsedAt || 0)));

        let html = "";

        data.keys.forEach(k => {
            const isExpired = k.expiresAt && k.expiresAt != 0 && Date.now() > Number(k.expiresAt);
            
            // --- CORRE√á√ÉO DA L√ìGICA DE REVOGA√á√ÉO ---
            // Converte para string e compara, garantindo que "true" e true funcionem
            const isRevoked = String(k.revoked).toLowerCase() === "true";
            
            // L√≥gica de Sess√£o
            const sessionExpirationTime = Number(k.sessionExpiresAt || 0);
            const isSessionActive = Date.now() < sessionExpirationTime;
            const sessionStatus = isSessionActive 
                ? `<span class="tag-session">ONLINE</span>` 
                : `<span style="color:#888; font-size:12px;">Offline</span>`;

            let validade = isExpired ? `<span style="color:#ff4d4d">Expirada</span>` : formatTime(k.expiresAt);
            
            const typeBadge = k.type === "vip" ? `<span class="tag-vip">VIP</span>` : `<span class="tag-time">TEMP</span>`;
            
            let revokedBadge = isRevoked ? `<span class="tag-revoked">SIM</span>` : `<span class="tag-active">N√ÉO</span>`;
            
            // Bot√µes condicionais baseados na vari√°vel corrigida 'isRevoked'
            let actionButtons = `
                ${isRevoked 
                    ? `<button class="btn-unrevoke" onclick="revokeKey('${k.key}', false)">‚úÖ Reativar</button>`
                    : `<button class="btn-revoke" onclick="revokeKey('${k.key}', true)">üö´ Revogar</button>`
                }
                <button class="btn-delete" onclick="deleteKey('${k.key}')">üóë</button>
            `;
            
            const hwidDisplay = k.hwid && k.hwid !== "-" ? `<span title="${k.hwid}" style="cursor:help; border-bottom:1px dotted #666;">${k.hwid.substring(0, 8)}...</span>` : '<span style="color:#555">N/A</span>';
            const lastUsedDisplay = formatLastUsed(k.lastUsedAt || 0);

            const rowStyle = isRevoked ? 'style="background-color: #3d1a1a;"' : (isExpired ? 'style="background-color: #2e2e2e; opacity:0.7;"' : '');

            html += `
                <tr ${rowStyle}>
                    <td style="font-family: monospace; color: #00aaff; font-weight:bold;">${k.key}</td>
                    <td>${typeBadge}</td>
                    <td>${validade}</td>
                    <td>${k.uses || 0}</td>
                    <td>${hwidDisplay}</td>
                    <td>${lastUsedDisplay}</td>
                    <td>${sessionStatus}</td>
                    <td>${revokedBadge}</td>
                    <td>${actionButtons}</td>
                </tr>
            `;
        });

        if(data.keys.length === 0) html = '<tr><td colspan="9" style="text-align:center; padding:20px;">Nenhuma key encontrada.</td></tr>';
        
        tableBody.innerHTML = html;

    } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:red;">${error.message}</td></tr>`;
    }
}

// --- L√ìGICA DISCORD (Simplificada para manter o c√≥digo limpo) ---
async function loadUsers() {
    // (Mesma l√≥gica do c√≥digo anterior, mantida para compatibilidade)
    document.getElementById("content").innerHTML = '<div class="card"><h3>Em constru√ß√£o...</h3><p>Use a aba de Gerenciar Keys para ver os donos.</p></div>';
}

</script>

</body>
</html>
