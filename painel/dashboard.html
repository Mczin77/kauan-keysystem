<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Administrativo - Mczin</title>
<style>
    /* ESTILOS MANTIDOS E IGUAIS AO ANTERIOR */
    body { display: none; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #e0e0e0; height: 100vh; }
    .sidebar { width: 250px; background: #141414; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: space-between; }
    .sidebar h2 { text-align: center; color: #00aaff; margin-bottom: 30px; font-size: 22px; }
    .sidebar button { width: 100%; padding: 12px; margin-top: 10px; background: transparent; border: 1px solid #333; border-radius: 6px; color: #ccc; cursor: pointer; transition: 0.2s; font-size: 15px; text-align: left; padding-left: 20px; }
    .sidebar button:hover { background: #1f1f1f; border-color: #00aaff; color: #00aaff; }
    .main { flex: 1; padding: 40px; overflow-y: auto; }
    .card { background: #1a1a1a; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; }
    .card h3 { margin-top: 0; color: #00aaff; border-bottom: 1px solid #333; padding-bottom: 15px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
    .input-group { display: flex; flex-direction: column; flex: 1; }
    .input-group label { font-size: 12px; margin-bottom: 5px; color: #888; }
    input, select, textarea { background: #252525; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; outline: none; width: 100%; box-sizing: border-box; font-family: inherit; }
    .btn-primary { background: #00aaff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-primary:hover { background: #0088cc; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th { text-align: left; padding: 12px; background: #252525; color: #aaa; font-weight: normal; }
    td { padding: 12px; border-bottom: 1px solid #2a2a2a; vertical-align: middle; }
    tr:hover td { background: #202020; }
    .tag-vip { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-time { background: #00aaff; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .tag-revoked { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-active { background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .tag-session { background: #2ecc71; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    .btn-action { border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 3px; color:white; font-weight: bold;}
    .btn-delete { background: #444; } .btn-delete:hover { background: #cc0000; }
    .btn-revoke { background: #e74c3c; } .btn-revoke:hover { background: #c0392b; }
    .btn-unrevoke { background: #2ecc71; } .btn-unrevoke:hover { background: #27ae60; }
    .btn-reset { background: #f39c12; color: black; } .btn-reset:hover { background: #d35400; color: white; }
    .btn-notify { background: #9b59b6; color: white; } .btn-notify:hover { background: #8e44ad; }
    .sys-card { flex:1; background:#222; padding:20px; border-radius:8px; border:1px solid #333; display:flex; flex-direction:column; justify-content:space-between; }
    .discord-box { display: flex; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-top: 20px; }
</style>
</head>
<body>

<script>
// CONFIGURA√á√ÉO DO TOKEN
const TOKEN_PADRAO = "Mczin121314#"; // Coloque sua senha aqui
let token = localStorage.getItem("panel_token"); 
if(!token && TOKEN_PADRAO !== "Mczin121314#") { token = TOKEN_PADRAO; localStorage.setItem("panel_token", TOKEN_PADRAO); }

// PROTE√á√ÉO INICIAL
(async function protectRoute() {
    if (!token) { window.location.href = "/"; return; }
    try {
        // Chama endpoint unificado com action=check
        const res = await fetch("/api/admin?action=check", { headers: { "x-panel-token": token } });
        const data = await res.json();
        if (data.ok) { document.body.style.display = "flex"; loadKeys(); } 
        else { localStorage.removeItem("panel_token"); window.location.href = "/"; }
    } catch (e) { window.location.href = "/"; }
})();
</script>

<div class="sidebar">
    <div>
        <h2>‚ö° Mczin Painel</h2>
        <button onclick="loadHome()">üè† In√≠cio</button>
        <button onclick="loadKeys()">üîë Gerenciar Keys</button>
        <button onclick="loadUsers()">üë§ Usu√°rios & Discord</button>
        <button onclick="loadSystem()" style="border-color: #ff9800; color: #ff9800;">üì¢ Sistema</button>
    </div>
    <button onclick="logout()" style="border-color:#ff4d4d; color:#ff4d4d;">üö™ Sair</button>
</div>

<div class="main" id="content"></div>

<script>
let foundUser = null; 
function logout() { localStorage.removeItem("panel_token"); window.location.href = "/"; }
function formatTime(timestamp) { if (timestamp == 0) return '‚àû Permanente'; if (timestamp < Date.now()) return `<span style="color:#ff4d4d">EXPIRADA</span>`; return new Date(Number(timestamp)).toLocaleString('pt-BR'); }
function formatLastUsed(timestamp) { if (timestamp == 0) return 'Nunca'; return new Date(Number(timestamp)).toLocaleString('pt-BR'); }
function loadHome() { document.getElementById("content").innerHTML = `<div class="card"><h3>Bem-vindo üéâ</h3><p>Selecione uma op√ß√£o no menu.</p></div>`; }

// --- API HELPER (Fun√ß√£o para chamar a API mestre) ---
async function apiCall(action, method = "POST", body = null) {
    const options = {
        method: method,
        headers: { "Content-Type": "application/json", "x-panel-token": token }
    };
    if (body) options.body = JSON.stringify(body);
    
    // URL aponta sempre para admin.js com o parametro action
    const url = `/api/admin?action=${action}${method === "GET" ? "" : ""}`; 
    
    const res = await fetch(url, options);
    return await res.json();
}

// --- SISTEMA GLOBAL ---
async function loadSystem() {
    const contentDiv = document.getElementById("content");
    contentDiv.innerHTML = '<div class="card"><h3>Carregando...</h3></div>';
    try {
        const data = await apiCall("global", "GET");
        const config = data.config || {};
        const isMaint = config.maintenance === "true";
        const isShutdown = config.shutdown === "true";
        const currentMsg = config.message || "";

        contentDiv.innerHTML = `
            <div class="card" style="border: 1px solid #ff9800;">
                <h3 style="color:#ff9800;">üì¢ Sistema Global</h3>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color:white; font-weight:bold;">Mensagem Global:</label>
                    <textarea id="globalMessage" rows="3" style="width:100%; background:#333; color:white; border:1px solid #555;">${currentMsg}</textarea>
                </div>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div class="sys-card"><h4>üõ†Ô∏è Manuten√ß√£o</h4><p>Bloqueia novos logins.</p>
                        <button id="btnMaint" onclick="toggleSystem('maintenance')" class="btn-primary" style="background:${isMaint ? '#e74c3c' : '#444'}">${isMaint ? 'DESATIVAR' : 'ATIVAR'}</button>
                    </div>
                    <div class="sys-card"><h4>üíÄ Shutdown</h4><p>Derruba todos online.</p>
                        <button id="btnShut" onclick="toggleSystem('shutdown')" class="btn-primary" style="background:${isShutdown ? '#e74c3c' : '#444'}">${isShutdown ? 'CANCELAR' : 'EXECUTAR'}</button>
                    </div>
                    <div class="sys-card"><h4>üì® Aviso</h4><p>Apenas envia a mensagem.</p>
                        <button onclick="toggleSystem('message')" class="btn-primary" style="background:#f39c12; color:black;">Enviar</button>
                    </div>
                </div>
            </div>`;
    } catch (e) { contentDiv.innerHTML = `<div class="card"><h3>Erro</h3><p>${e.message}</p></div>`; }
}

async function toggleSystem(type) {
    const msg = document.getElementById("globalMessage").value;
    const btnMaint = document.getElementById("btnMaint");
    const btnShut = document.getElementById("btnShut");
    let maintenance = btnMaint.innerText.includes("DESATIVAR");
    let shutdown = btnShut.innerText.includes("CANCELAR");

    if (type === 'maintenance') maintenance = !maintenance;
    if (type === 'shutdown') shutdown = !shutdown;
    if (type === 'shutdown' && shutdown && !confirm("Derrubar todos os usu√°rios?")) return;

    const data = await apiCall("global", "POST", { maintenance, shutdown, message: msg });
    if(data.ok) { alert("Atualizado!"); loadSystem(); } else { alert("Erro"); }
}

// --- KEYS ---
async function resetHWID(key) {
    if (!confirm(`Resetar HWID da key ${key}?`)) return;
    const data = await apiCall("reset_hwid", "POST", { key });
    if(data.ok) { alert("Resetado!"); loadKeys(); } else { alert("Erro: " + data.error); }
}

async function revokeKey(key, state) {
    if (!confirm(`${state ? 'BLOQUEAR' : 'DESBLOQUEAR'} key ${key}?`)) return;
    const data = await apiCall("revoke", "POST", { key, state });
    if(data.ok) loadKeys(); else alert("Erro");
}

async function deleteKey(key) {
    if (!confirm(`Apagar key ${key}?`)) return;
    const data = await apiCall("delete", "POST", { key });
    if(data.ok) loadKeys(); else alert("Erro");
}

async function createKey() {
    const type = document.getElementById("typeInput").value;
    const days = document.getElementById("daysInput").value;
    const hours = document.getElementById("hoursInput").value;
    document.getElementById("generateResult").innerHTML = "Gerando...";
    
    const data = await apiCall("generate", "POST", { type, days, hours });
    
    if (data.ok) {
        document.getElementById("generateResult").innerHTML = `‚úÖ Key: <strong style="color:#2ecc71;">${data.data.key}</strong>`;
        loadKeys(); 
    } else { document.getElementById("generateResult").innerHTML = `‚ùå Erro`; }
}

async function loadKeys() {
    const contentDiv = document.getElementById("content");
    if (!document.getElementById("keysTable")) {
        contentDiv.innerHTML = `
        <div class="card"><h3>Gerar Key ‚ö°</h3><div class="form-row"><div class="input-group" style="flex:none; width: 150px;"><label>Tipo</label><select id="typeInput"><option value="temp">Tempor√°rio</option><option value="vip">VIP</option></select></div><div class="input-group" style="flex:none; width: 80px;"><label>Dias</label><input type="number" id="daysInput" value="1"></div><div class="input-group" style="flex:none; width: 80px;"><label>Horas</label><input type="number" id="hoursInput" value="0"></div><div class="input-group" style="flex:none;"><label>&nbsp;</label><button class="btn-primary" onclick="createKey()">+ Gerar</button></div></div><p id="generateResult"></p></div>
        <div class="card"><div style="display:flex; justify-content:space-between;"><h3 style="margin:0;">Lista de Keys</h3><button class="btn-primary" onclick="loadKeys()">üîÑ</button></div><table id="keysTable"><thead><tr><th>Key</th><th>Tipo</th><th>Validade</th><th>Usos</th><th>HWID</th><th>√öltimo Uso</th><th>Sess√£o</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="keysTableBody"><tr><td colspan="9" style="text-align:center">Carregando...</td></tr></tbody></table></div>`;
    }
    
    const data = await apiCall("list", "GET");
    if(data.ok) {
        data.keys.sort((a, b) => (Number(b.lastUsedAt || 0) - Number(a.lastUsedAt || 0)));
        let html = "";
        data.keys.forEach(k => {
            const isExpired = k.expiresAt && k.expiresAt != 0 && Date.now() > Number(k.expiresAt);
            const isRevoked = String(k.revoked).toLowerCase() === "true";
            const sessionActive = Date.now() < Number(k.sessionExpiresAt || 0);
            
            let actions = `
                <button class="btn-action btn-reset" onclick="resetHWID('${k.key}')">üîÑ</button>
                ${isRevoked ? `<button class="btn-action btn-unrevoke" onclick="revokeKey('${k.key}', false)">‚úÖ</button>` : `<button class="btn-action btn-revoke" onclick="revokeKey('${k.key}', true)">üö´</button>`}
                <button class="btn-action btn-delete" onclick="deleteKey('${k.key}')">üóë</button>
            `;
            const hwid = k.hwid && k.hwid !== "-" ? `<span title="${k.hwid}">${k.hwid.substring(0, 8)}...</span>` : 'N/A';
            const rowStyle = isRevoked ? 'style="background-color: #3d1a1a;"' : (isExpired ? 'style="background-color: #2e2e2e; opacity:0.7;"' : '');
            
            html += `<tr ${rowStyle}><td style="font-family:monospace;color:#00aaff;">${k.key}</td><td>${k.type.toUpperCase()}</td><td>${isExpired ? 'EXPIRADA' : formatTime(k.expiresAt)}</td><td>${k.uses}</td><td>${hwid}</td><td>${formatLastUsed(k.lastUsedAt)}</td><td>${sessionActive ? '<span class="tag-session">ON</span>' : 'Off'}</td><td>${isRevoked ? 'BLOQ' : 'OK'}</td><td>${actions}</td></tr>`;
        });
        document.getElementById("keysTableBody").innerHTML = data.keys.length ? html : '<tr><td colspan="9" style="text-align:center;">Vazio</td></tr>';
    }
}

// --- USU√ÅRIOS ---
async function loadUsers() {
    const contentDiv = document.getElementById("content");
    contentDiv.innerHTML = '<div class="card"><h3>Carregando...</h3></div>';
    const dataKeys = await apiCall("list", "GET");
    const allKeys = dataKeys.keys || [];
    let options = `<option value="">Selecione...</option>`;
    allKeys.forEach(k => { options += `<option value="${k.key}">${k.key} - ${k.type.toUpperCase()} ${k.ownerName ? `(Dono: ${k.ownerName})` : "(Livre)"}</option>`; });

    contentDiv.innerHTML = `
        <div class="card"><h3>Vincular Discord üéÆ</h3><div class="form-row"><div class="input-group" style="flex:1"><label>ID Discord</label><input type="text" id="discordIdInput"></div><div class="input-group"><label>&nbsp;</label><button class="btn-primary" onclick="searchDiscordUser()">üîç Buscar</button></div></div>
        <div id="discordResult" class="discord-box" style="display:none;"><img id="userAvatar" src="" style="width:50px;height:50px;border-radius:50%;"><div><h4 id="userName" style="margin:0;color:white;">User</h4><span id="userIdDisplay" style="font-size:12px;color:#888;">ID</span></div></div>
        <div id="assignArea" style="display:none; margin-top:10px;"><div class="input-group"><label>Key:</label><select id="keySelect">${options}</select></div><button class="btn-primary" style="width:100%; margin-top:10px;" onclick="saveUserToKey()">Vincular</button></div></div>
        <div class="card"><h3>Usu√°rios Vinculados</h3><table><thead><tr><th>Perfil</th><th>Nome</th><th>Key</th><th>A√ß√µes</th></tr></thead><tbody id="usersTableBody"></tbody></table></div>`;
    
    renderUsers(allKeys);
}

async function searchDiscordUser() {
    const id = document.getElementById("discordIdInput").value;
    if (!id) return alert("ID?");
    
    // Chama api/admin?action=discord_search&id=...
    const res = await fetch(`/api/admin?action=discord_search&id=${id}`, { headers: { "x-panel-token": token } });
    const data = await res.json();
    
    if(data.ok) {
        foundUser = data;
        document.getElementById("discordResult").style.display = "flex";
        document.getElementById("assignArea").style.display = "block";
        document.getElementById("userAvatar").src = data.avatar;
        document.getElementById("userName").innerText = data.username;
        document.getElementById("userIdDisplay").innerText = data.id;
    } else { alert("N√£o encontrado"); }
}

async function saveUserToKey() {
    const key = document.getElementById("keySelect").value;
    if(!key) return;
    const data = await apiCall("assign", "POST", { key, discordId: foundUser.id, discordName: foundUser.username, discordAvatar: foundUser.avatar });
    if(data.ok) { alert("Vinculado!"); loadUsers(); } else { alert("Erro"); }
}

async function notifyUser(key, name) {
    const msg = prompt(`Mensagem para ${name} (ou digite 'tempo'):`);
    if(!msg) return;
    const type = msg.toLowerCase() === 'tempo' ? 'time' : 'custom';
    const data = await apiCall("notify", "POST", { key, messageType: type, customMessage: msg });
    if(data.ok) alert("Enviado!"); else alert("Erro: " + data.error);
}

function renderUsers(keys) {
    const tbody = document.getElementById("usersTableBody");
    const linked = keys.filter(k => k.ownerId);
    let html = "";
    linked.forEach(k => {
        html += `<tr><td><img src="${k.ownerAvatar}" style="width:30px;height:30px;border-radius:50%;"></td><td>${k.ownerName}</td><td style="font-family:monospace;color:#00aaff;">${k.key}</td><td><button class="btn-action btn-notify" onclick="notifyUser('${k.key}', '${k.ownerName}')">üì©</button></td></tr>`;
    });
    tbody.innerHTML = linked.length ? html : '<tr><td colspan="4" style="text-align:center;">Vazio</td></tr>';
}
</script>
</body>
</html>
